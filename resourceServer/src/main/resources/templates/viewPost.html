<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title id="page-title">게시글 상세</title>
    <!-- 스타일 생략 -->
</head>
<body>

<h1 id="post-title">로딩 중...</h1>

<div class="meta">
    작성자: <span id="post-author">-</span>
</div>

<div class="stats">
    조회수: <span id="post-viewCount">0</span> |
    좋아요: <span id="post-likeCount">0</span>
</div>

<div class="content" id="post-content">
    로딩 중...
</div>

<hr />

<div class="comments">
    <h2>댓글 (<span id="comment-count">0</span>)</h2>
    <div id="comment-list">
        댓글 로딩 중...
    </div>
</div>

<script type="module">
    import { loadProtectedData } from "/js/apiRequest.js";

    // URL에서 postId를 가져오는 간단한 함수
    function getPostIdFromURL() {
        const path = window.location.pathname; // 예: /board/123
        const parts = path.split('/');
        return parts.length > 2 ? parts[2] : null;
    }

    // XSS 방지용 이스케이프 함수
    function escapeHtml(text) {
        if (!text) return "";
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    async function renderPost() {
        const postId = getPostIdFromURL();
        if (!postId) {
            alert("잘못된 게시글 주소입니다.");
            return;
        }

        const post = await loadProtectedData(`/api/board/${postId}`);
        if (!post) {
            alert("게시글을 불러오지 못했습니다.");
            return;
        }

        document.getElementById("page-title").textContent = post.title;
        document.getElementById("post-title").textContent = post.title;
        document.getElementById("post-author").textContent = post.authorName || "-";
        document.getElementById("post-viewCount").textContent = post.viewCount ?? 0;
        document.getElementById("post-likeCount").textContent = post.likeCount ?? 0;
        document.getElementById("post-content").textContent = post.content || "";

        const commentList = document.getElementById("comment-list");
        commentList.innerHTML = "";
        if (!post.comments || post.comments.length === 0) {
            commentList.textContent = "댓글이 없습니다.";
        } else {
            post.comments.forEach(c => {
                const div = document.createElement("div");
                div.className = "comment";

                const author = document.createElement("div");
                author.className = "comment-author";
                author.textContent = c.authorName || "익명";

                const content = document.createElement("div");
                content.className = "comment-content";
                content.textContent = c.content || "";

                div.appendChild(author);
                div.appendChild(content);
                commentList.appendChild(div);
            });
        }

        document.getElementById("comment-count").textContent = post.comments ? post.comments.length : 0;
    }

    window.addEventListener("DOMContentLoaded", renderPost);
</script>

</body>
</html>
