<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Server - 게시글 작성</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
        }
        .main-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 0;
        }
        .card {
            background: rgba(255,255,255,0.95);
            border: none;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 700px;
        }
        .card-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px 20px 0 0 !important;
            border: none;
            padding: 2rem;
            text-align: center;
        }
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102,126,234,0.25);
        }
        .form-control.is-invalid {
            border-color: #dc3545;
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102,126,234,0.3);
            color: white;
        }
        .error-msg {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: block;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body>

<div class="container main-container">
    <div class="card">
        <div class="card-header">
            <h1 class="mb-0"><i class="fas fa-edit me-3"></i>게시글 작성</h1>
            <p class="mb-0 mt-3 opacity-75">제목과 내용을 입력하세요</p>
        </div>
        <div class="card-body p-4">
            <form id="postForm">
                <div class="mb-3">
                    <label for="title" class="form-label">제목</label>
                    <input type="text" class="form-control" id="title" name="title" placeholder="제목을 입력하세요">
                    <div id="titleError" class="error-msg"></div>
                </div>
                <div class="mb-3">
                    <label for="content" class="form-label">내용</label>
                    <textarea class="form-control" id="content" name="content" rows="8" placeholder="내용을 입력하세요"></textarea>
                    <div id="contentError" class="error-msg"></div>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary" id="submitBtn">게시글 작성</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
<script type="module">
    import { postData } from '/js/api.js';

    class PostFormHandler {
        constructor() {
            this.form = document.getElementById('postForm');
            this.titleInput = document.getElementById('title');
            this.contentInput = document.getElementById('content');
            this.titleErrorDiv = document.getElementById('titleError');
            this.contentErrorDiv = document.getElementById('contentError');
            this.submitBtn = document.getElementById('submitBtn');
            this.initEventListeners();
        }

        initEventListeners() {
            this.form.addEventListener('submit', (e) => this.handleSubmit(e));
        }

        async handleSubmit(e) {
            e.preventDefault();
            this.clearErrors();
            this.setLoading(true);

            const data = {
                title: this.titleInput.value.trim(),
                content: this.contentInput.value.trim()
            };

            try {
                const res = await postData('/post/add', data);
                if (res && res.postId) {
                    window.location.href = `/board/${res.postId}`;
                }
            } catch (err) {
                console.error('Captured error object:', err);

                if (err && typeof err === 'object' && (err.title || err.content)) {
                    this.displayValidationErrors(err);
                } else {
                    this.showErrorToast('알 수 없는 오류가 발생했습니다.');
                }
            } finally {
                this.setLoading(false);
            }
        }

        displayValidationErrors(errors) {
            if (errors.title) {
                this.titleErrorDiv.textContent = errors.title;
                this.titleInput.classList.add('is-invalid');
            }

            if (errors.content) {
                this.contentErrorDiv.textContent = errors.content;
                this.contentInput.classList.add('is-invalid');
            }
        }

        clearErrors() {
            [this.titleErrorDiv, this.contentErrorDiv].forEach(div => div.textContent = '');
            [this.titleInput, this.contentInput].forEach(input => input.classList.remove('is-invalid', 'is-valid'));
        }

        setLoading(isLoading) {
            if (isLoading) {
                this.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>작성 중...';
                this.submitBtn.disabled = true;
                this.form.classList.add('loading');
            } else {
                this.submitBtn.innerHTML = '<i class="fas fa-edit me-2"></i>게시글 작성';
                this.submitBtn.disabled = false;
                this.form.classList.remove('loading');
            }
        }

        showErrorToast(message){
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 p-3';
            toast.style.zIndex = '1050';
            toast.innerHTML = `<div class="toast show" role="alert">
                <div class="toast-header bg-danger text-white"><i class="fas fa-exclamation-circle me-2"></i><strong class="me-auto">오류</strong></div>
                <div class="toast-body">${message}</div>
            </div>`;
            document.body.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new PostFormHandler();
    });
</script>
</body>
</html>